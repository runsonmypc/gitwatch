#!/bin/bash
watch -t -n 1 -c '
# Branch + sync status
branch=$(git branch --show-current)
upstream=$(git rev-parse --abbrev-ref @{u} 2>/dev/null)
if [ -n "$upstream" ]; then
  counts=$(git rev-list --left-right --count $upstream...HEAD 2>/dev/null)
  behind=$(echo $counts | awk "{print \$1}")
  ahead=$(echo $counts | awk "{print \$2}")
  sync=""
  [ "$ahead" -gt 0 ] && sync="${sync} ↑${ahead}"
  [ "$behind" -gt 0 ] && sync="${sync} ↓${behind}"
  [ "$ahead" -eq 0 ] && [ "$behind" -eq 0 ] && sync=" ✓"
  printf "\033[35m%s\033[0m%s\n" "$branch" "$sync"
else
  printf "\033[35m%s\033[0m \033[2m(no remote)\033[0m\n" "$branch"
fi

# Last commit
git log -1 --format="%C(yellow)%h%C(reset) %s %C(dim)(%cr)%C(reset)"

echo ""

# Staged changes (without summary)
staged=$(git diff --cached --stat --color)
if [ -n "$staged" ]; then
  printf "\033[94m● staged\033[0m\n"
  echo "$staged" | sed "/files\{0,1\} changed/d"
  echo ""
fi

# Unstaged changes (without summary)
unstaged=$(git diff --stat --color)
if [ -n "$unstaged" ]; then
  printf "\033[36m○ unstaged\033[0m\n"
  echo "$unstaged" | sed "/files\{0,1\} changed/d"
  echo ""
fi

# Untracked files
untracked=$(git status --porcelain -uall | grep "^??" | cut -c4-)
if [ -n "$untracked" ]; then
  printf "\033[33m◌ untracked\033[0m\n"
  # Collect file data and find max widths
  data=""
  maxname=0
  maxlines=0
  while read -r file; do
    lines=$(wc -l < "$file" 2>/dev/null | tr -d " ")
    [ -z "$lines" ] && lines=0
    display="$file"
    if [ ${#file} -gt 35 ]; then
      # Truncate at directory boundary like git does
      tail="${file: -32}"
      tail="${tail#*/}"
      display=".../$tail"
    fi
    [ ${#display} -gt $maxname ] && maxname=${#display}
    [ $lines -gt $maxlines ] && maxlines=$lines
    data="${data}${display}|${lines}\n"
  done <<< "$untracked"
  # Calculate number width
  numwidth=${#maxlines}
  [ $numwidth -lt 3 ] && numwidth=3
  # Print aligned
  printf "%b" "$data" | while IFS="|" read -r name count; do
    [ -n "$name" ] && printf " %-${maxname}s | \033[33m%${numwidth}d\033[0m\n" "$name" "$count"
  done
  echo ""
fi

# Summary at the bottom
tracked=$(git diff --shortstat 2>/dev/null | awk "{
  files=\$1
  ins=0; del=0
  for(i=1;i<=NF;i++) {
    if(\$i ~ /insertion/) ins=\$(i-1)
    if(\$i ~ /deletion/) del=\$(i-1)
  }
  if(files) printf \"\033[2m%dΔ\033[0m  \033[32m+%d\033[0m  \033[31m-%d\033[0m\", files, ins, del
}")
newcount=$(git status --porcelain -uall 2>/dev/null | grep -c "^??")
if [ -n "$tracked" ] && [ "$newcount" -gt 0 ]; then
  printf " %s   \033[2m%d new\033[0m\n" "$tracked" "$newcount"
elif [ -n "$tracked" ]; then
  printf " %s\n" "$tracked"
elif [ "$newcount" -gt 0 ]; then
  printf " \033[2m%d new\033[0m\n" "$newcount"
fi
'
